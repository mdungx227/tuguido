<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Smart Locker - B·∫£ng ƒëi·ªÅu khi·ªÉn c∆∞ d√¢n</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Font gi·ªëng trang auth -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --wood-bg-1: #fff7d9;
            --wood-bg-2: #f6cf7c;
            --wood-accent: #f4a226;
            --wood-accent-dark: #c97a12;
            --wood-text: #4b3b2a;
            --error: #dc2626;
            --success: #16a34a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top left, var(--wood-bg-1), var(--wood-bg-2));
            color: var(--wood-text);
        }

        .dash-shell {
            width: 100%;
            max-width: 900px;
            padding: 16px;
        }

        .dash-card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 22px;
            box-shadow:
                0 22px 45px rgba(0, 0, 0, 0.12),
                0 0 0 1px rgba(0, 0, 0, 0.03);
            padding: 18px 18px 16px;
            position: relative;
            overflow: hidden;
        }

        .dash-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(135deg, rgba(244, 162, 38, 0.08), transparent 55%),
                repeating-linear-gradient(
                    -45deg,
                    rgba(249, 207, 124, 0.08),
                    rgba(249, 207, 124, 0.08) 6px,
                    transparent 6px,
                    transparent 12px
                );
            pointer-events: none;
        }

        .dash-inner {
            position: relative;
            z-index: 1;
        }

        /* Header */

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .brand-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-icon {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(145deg, var(--wood-accent), var(--wood-accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 22px;
            box-shadow: 0 6px 14px rgba(201, 122, 18, 0.5);
        }

        .brand-text h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .brand-text p {
            margin: 2px 0 0;
            font-size: 12px;
            opacity: 0.8;
        }

        .user-info {
            text-align: right;
            font-size: 12px;
        }

        .user-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(255, 237, 213, 0.9);
            border: 1px solid rgba(148, 121, 72, 0.35);
            color: var(--wood-text);
        }

        #userRoleBadge {
            margin-left: 4px;
            border-radius: 999px;
            padding: 1px 7px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-logout {
            background: linear-gradient(135deg, #f97316, #b45309);
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 8px rgba(180, 83, 9, 0.4);
        }

        .btn-logout:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
        }

        /* Status strip */

        .status-strip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: #fffbeb;
            border: 1px dashed rgba(180, 119, 41, 0.45);
            font-size: 11px;
            margin-bottom: 10px;
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
        }

        /* Tabs */

        .dash-tabs {
            display: inline-flex;
            border-radius: 999px;
            background: rgba(255, 237, 213, 0.9);
            padding: 4px;
            margin-top: 8px;
            margin-bottom: 6px;
        }

        .dash-tab {
            border-radius: 999px;
            border: none;
            padding: 7px 14px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            color: rgba(76, 57, 34, 0.8);
        }

        .dash-tab.active {
            background: linear-gradient(135deg, var(--wood-accent), var(--wood-accent-dark));
            color: #fff;
            box-shadow: 0 4px 10px rgba(201, 122, 18, 0.45);
        }

        .dash-body {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
            gap: 14px;
            margin-top: 10px;
        }

        @media (max-width: 800px) {
            .dash-body {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .dash-section {
            border-radius: 18px;
            padding: 12px 12px 10px;
            background: rgba(255, 250, 235, 0.95);
            border: 1px solid rgba(212, 163, 72, 0.4);
            font-size: 13px;
        }

        .dash-section.hidden {
            display: none;
        }

        .dash-section h3 {
            margin: 0 0 6px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dash-section p {
            margin: 0 0 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        label {
            display: block;
            margin-top: 8px;
            font-size: 13px;
        }

        select,
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 7px 9px;
            border-radius: 10px;
            border: 1px solid rgba(148, 121, 72, 0.4);
            outline: none;
            font-size: 13px;
            margin-top: 2px;
            background: rgba(255, 255, 255, 0.9);
            transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        }

        select:focus,
        input[type="number"]:focus,
        input[type="text"]:focus {
            border-color: var(--wood-accent);
            box-shadow: 0 0 0 1px rgba(244, 162, 38, 0.25),
                        0 0 0 4px rgba(244, 162, 38, 0.1);
            background: #fffbeb;
        }

        .btn-primary {
            margin-top: 10px;
            padding: 7px 13px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #22c55e, #15803d);
            color: #fff;
            box-shadow: 0 4px 10px rgba(21, 128, 61, 0.5);
        }

        .btn-secondary {
            margin-top: 6px;
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid rgba(148, 121, 72, 0.5);
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fffbeb;
            color: var(--wood-text);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: wait;
            box-shadow: none;
        }

        #reserveResult {
            margin-top: 9px;
            font-size: 12px;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(22, 163, 74, 0.08);
            border: 1px solid rgba(22, 163, 74, 0.5);
            color: #166534;
        }

        /* L·ªãch s·ª≠ */

        #historyEmpty {
            margin-top: 8px;
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
        }

        #historyTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 11px;
        }

        #historyTable th,
        #historyTable td {
            padding: 4px 6px;
            border-bottom: 1px solid rgba(148, 121, 72, 0.4);
            text-align: left;
        }

        #historyTable th {
            font-weight: 600;
            font-size: 11px;
        }

        .footer-note {
            margin-top: 10px;
            font-size: 11px;
            text-align: right;
            opacity: 0.75;
        }

        .pickup-box {
            margin-top: 4px;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255, 247, 237, 0.95);
            border: 1px solid rgba(212, 163, 72, 0.6);
            font-size: 12px;
        }

        .pickup-box h4 {
            margin: 0 0 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pickup-info-row {
            margin-top: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="dash-shell">
        <div class="dash-card">
            <div class="dash-inner">
                <!-- HEADER -->
                <header class="dash-header">
                    <div class="brand-left">
                        <div class="brand-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="brand-text">
                            <h1>Smart Locker Chung C∆∞</h1>
                            <p>ƒê·∫∑t t·ªß g·ª≠i ƒë·ªì, nh·∫≠n h√†ng & xem l·ªãch s·ª≠</p>
                        </div>
                    </div>

                    <div class="user-info">
                        <div class="user-pill">
                            <i class="fas fa-user"></i>
                            <span id="userPhone">--</span>
                            <span id="userRoleBadge"></span>
                        </div>
                        <div>
                            <button class="btn-logout" onclick="authManager.logout()">
                                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                            </button>
                        </div>
                    </div>
                </header>

                <!-- STATUS NH·ªé -->
                <div class="status-strip">
                    <div class="status-chip">
                        <span class="status-dot" id="connectionStatus"></span>
                        <span id="connectionText">ƒêang k·∫øt n·ªëi t·ªß...</span>
                    </div>
                    <div style="font-size: 11px; opacity: 0.85;">
                        <i class="fas fa-circle-info"></i>
                        ƒê·∫∑t t·ªß ƒë·ªÉ shipper g·ª≠i ƒë·ªì, sau ƒë√≥ nh·∫≠n h√†ng b·∫±ng OTP v√† theo d√µi l·ªãch s·ª≠.
                    </div>
                </div>

                <!-- TABS -->
                <div class="dash-tabs">
                    <button id="tabReserve" class="dash-tab active">
                        <i class="fas fa-box-open"></i>
                        ƒê·∫∑t t·ªß g·ª≠i ƒë·ªì
                    </button>
                    <button id="tabHistory" class="dash-tab">
                        <i class="fas fa-clock-rotate-left"></i>
                        L·ªãch s·ª≠ & Nh·∫≠n h√†ng
                    </button>
                </div>

                <!-- MAIN BODY -->
                <div class="dash-body">
                    <!-- PANEL ƒê·∫∂T T·ª¶ -->
                    <section id="sectionReserve" class="dash-section">
                        <h3><i class="fas fa-box-open"></i> ƒê·∫∑t t·ªß g·ª≠i ƒë·ªì</h3>
                        <p>
                            Ch·ªçn t·ªß mu·ªën ƒë·∫∑t. H·ªá th·ªëng s·∫Ω t·∫°o m√£ ƒë·∫∑t t·ªß, b·∫°n g·ª≠i m√£ ƒë√≥ cho shipper ƒë·ªÉ h·ªç b·ªè h√†ng v√†o.
                        </p>

                        <div class="setting-item">
                            <label for="lockerSelect">Ch·ªçn t·ªß:</label>
                            <select id="lockerSelect">
                                <option value="Locker1">Locker 1</option>
                                <!-- sau n√†y c√≥ th·ªÉ th√™m Locker2, Locker3... -->
                            </select>
                        </div>

                        <button id="reserveBtn" class="btn-primary" onclick="reserveLocker()">
                            <i class="fas fa-calendar-plus"></i> ƒê·∫∑t t·ªß
                        </button>

                        <div id="reserveResult" style="display:none;"></div>
                    </section>

                    <!-- PANEL L·ªäCH S·ª¨ + NH·∫¨N H√ÄNG -->
                    <section id="sectionHistory" class="dash-section hidden">
                        <h3><i class="fas fa-clock-rotate-left"></i> Nh·∫≠n h√†ng & l·ªãch s·ª≠ ƒë·∫∑t t·ªß</h3>
                        <p>
                            Ki·ªÉm tra xem b·∫°n c√≥ ƒë∆°n h√†ng ƒëang ch·ªù trong t·ªß kh√¥ng, sau ƒë√≥ nh·∫≠p OTP ƒë·ªÉ m·ªü t·ªß l·∫•y h√†ng.
                        </p>

                        <!-- KH·ªêI NH·∫¨N H√ÄNG -->
                        <div class="pickup-box">
                            <h4><i class="fas fa-box"></i> Nh·∫≠n h√†ng b·∫±ng OTP</h4>
                            <p style="margin: 0 0 6px;">
                                B·∫•m ki·ªÉm tra, n·∫øu c√≥ ƒë∆°n ƒëang ch·ªù h·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã th√¥ng tin t·ªß. Sau ƒë√≥ nh·∫≠p OTP m√† h·ªá th·ªëng g·ª≠i cho b·∫°n.
                            </p>

                            <button id="btnCheckPickup" class="btn-secondary" onclick="checkReceiverReservation()">
                                <i class="fas fa-magnifying-glass"></i> Ki·ªÉm tra ƒë∆°n h√†ng ƒëang ch·ªù
                            </button>

                            <div id="pickupStatus" style="margin-top:6px; font-size:12px; display:none;"></div>

                            <div id="pickupDetail" style="display:none; margin-top:6px;">
                                <div class="pickup-info-row">
                                    <strong>T·ªß: </strong><span id="pickupLocker">-</span>
                                </div>
                                <div class="pickup-info-row">
                                    <strong>Tr·∫°ng th√°i: </strong><span id="pickupStatusText">-</span>
                                </div>
                                <div class="pickup-info-row">
                                    <strong>H·∫øt h·∫°n: </strong><span id="pickupExpire">-</span>
                                </div>
                            </div>

                            <div id="pickupOtpBox" style="display:none; margin-top:8px;">
                                <label for="pickupOtp" style="margin-top:4px;">Nh·∫≠p OTP nh·∫≠n h√†ng:</label>
                                <input type="text" id="pickupOtp" placeholder="6 s·ªë OTP nh·∫≠n h√†ng">
                                <button id="btnPickupOpen" class="btn-primary" style="margin-top:8px;" onclick="verifyPickupOtp()">
                                    <i class="fas fa-door-open"></i> M·ªü t·ªß l·∫•y h√†ng
                                </button>
                            </div>
                        </div>

                        <!-- L·ªäCH S·ª¨ -->
                        <p style="margin-top:10px;">
                            <strong>L·ªãch s·ª≠ ƒë·∫∑t t·ªß</strong> ‚Äì C√°c l∆∞·ª£t ƒë·∫∑t t·ªß g·∫ßn ƒë√¢y c·ªßa s·ªë ƒëi·ªán tho·∫°i n√†y.
                        </p>

                        <button class="btn-secondary" onclick="loadReservations()">
                            <i class="fas fa-rotate-right"></i> T·∫£i l·∫°i l·ªãch s·ª≠
                        </button>

                        <div id="historyEmpty" style="display:none;">
                            Ch∆∞a c√≥ l∆∞·ª£t ƒë·∫∑t t·ªß n√†o.
                        </div>

                        <table id="historyTable" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian</th>
                                    <th>T·ªß</th>
                                    <th>M√£ ƒë·∫∑t t·ªß</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>H·∫øt h·∫°n</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </section>
                </div>

                <div class="footer-note">
                    <i class="fas fa-lightbulb"></i>
                    G·ª£i √Ω: Ch·ª•p m√†n h√¨nh m√£ ƒë·∫∑t t·ªß ƒë·ªÉ g·ª≠i nhanh cho shipper.
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v12 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBqfcOprdE5MT6m1yfXmRDtCzngtX86-7U",
            authDomain: "minhquang-36ee2.firebaseapp.com",
            databaseURL: "https://minhquang-36ee2-default-rtdb.firebaseio.com",
            projectId: "minhquang-36ee2",
            storageBucket: "minhquang-36ee2.firebasestorage.app",
            messagingSenderId: "986858991599",
            appId: "1:986858991599:web:53c36493204131a10c501a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make database available globally (n·∫øu script.js c·∫ßn)
        window.database = database;
        window.ref = ref;
        window.onValue = onValue;
        window.set = set;
        window.get = get;

        console.log('‚úÖ Firebase v12 ƒë√£ kh·ªüi t·∫°o th√†nh c√¥ng');
    </script>

    <!-- Auth -->
    <script src="auth.js"></script>
    <script>
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p & hi·ªÉn th·ªã info user
        if (!authManager.requireAuth()) {
            // s·∫Ω redirect v·ªÅ login n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        } else {
            const phoneSpan = document.getElementById('userPhone');
            if (phoneSpan) {
                phoneSpan.textContent = authManager.formatPhoneNumber(authManager.phoneNumber);
            }

            const role = localStorage.getItem("role") || "resident";
            const rb = document.getElementById("userRoleBadge");
            if (rb) {
                rb.textContent = role;
                if (role === "admin") {
                    rb.style.borderColor = "#fbbf24";
                    rb.style.color = "#92400e";
                    rb.style.background = "rgba(252, 211, 77, 0.4)";
                } else {
                    rb.style.borderColor = "rgba(148,121,72,0.5)";
                    rb.style.color = "rgba(76,57,34,0.9)";
                    rb.style.background = "rgba(255,237,213,0.8)";
                }
            }
        }

        // Tabs ƒê·∫∑t t·ªß / L·ªãch s·ª≠ & Nh·∫≠n h√†ng
        const tabReserve = document.getElementById("tabReserve");
        const tabHistory = document.getElementById("tabHistory");
        const sectionReserve = document.getElementById("sectionReserve");
        const sectionHistory = document.getElementById("sectionHistory");

        function showSection(name) {
            if (name === "reserve") {
                tabReserve.classList.add("active");
                tabHistory.classList.remove("active");
                sectionReserve.classList.remove("hidden");
                sectionHistory.classList.add("hidden");
            } else {
                tabHistory.classList.add("active");
                tabReserve.classList.remove("active");
                sectionHistory.classList.remove("hidden");
                sectionReserve.classList.add("hidden");
                // m·ªói l·∫ßn chuy·ªÉn sang tab l·ªãch s·ª≠ th√¨ t·∫£i l·∫°i
                loadReservations();
            }
        }

        tabReserve.addEventListener("click", () => showSection("reserve"));
        tabHistory.addEventListener("click", () => showSection("history"));
    </script>

    <!-- Logic ƒê·∫∂T T·ª¶ & L·ªäCH S·ª¨ & NH·∫¨N H√ÄNG -->
    <script>
        const API_BASE = "http://localhost:3000/api";
        let currentPickupReservationId = null;

        function setReserveLoading(loading) {
            const btn = document.getElementById("reserveBtn");
            if (!btn) return;
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ƒë·∫∑t...';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calendar-plus"></i> ƒê·∫∑t t·ªß';
            }
        }

        async function reserveLocker() {
            const lockerId = document.getElementById("lockerSelect").value;
            const resultEl = document.getElementById("reserveResult");

            if (!lockerId) {
                alert("Vui l√≤ng ch·ªçn t·ªß.");
                return;
            }

            if (resultEl) resultEl.style.display = "none";
            setReserveLoading(true);

            try {
                const res = await fetch(`${API_BASE}/user/reserve-locker`, {
                    method: "POST",
                    headers: authManager.getAuthHeaders(),
                    body: JSON.stringify({ lockerId })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) {
                    throw new Error(data.error || "ƒê·∫∑t t·ªß th·∫•t b·∫°i");
                }

                if (resultEl) {
                    const expireText = new Date(data.expiresAt).toLocaleString("vi-VN");
                    resultEl.innerHTML = `
                        <strong>ƒê·∫∑t t·ªß th√†nh c√¥ng!</strong><br>
                        T·ªß: <b>${data.lockerId}</b><br>
                        M√£ ƒë·∫∑t t·ªß: <b>${data.bookingCode}</b><br>
                        H·∫°n s·ª≠ d·ª•ng: ${expireText}<br>
                        <span style="font-size:12px; color:#9ca3af;">H√£y g·ª≠i m√£ n√†y cho shipper.</span>
                    `;
                    resultEl.style.display = "block";
                }

                // load l·∫°i l·ªãch s·ª≠
                loadReservations();
            } catch (err) {
                console.error(err);
                alert(err.message || "Kh√¥ng th·ªÉ ƒë·∫∑t t·ªß.");
            } finally {
                setReserveLoading(false);
            }
        }

        async function loadReservations() {
            const table = document.getElementById("historyTable");
            const tbody = document.getElementById("historyTableBody");
            const emptyEl = document.getElementById("historyEmpty");
            if (!tbody) return;

            tbody.innerHTML = "";
            if (emptyEl) emptyEl.style.display = "none";
            if (table) table.style.display = "none";

            try {
                const res = await fetch(`${API_BASE}/user/reservations`, {
                    method: "GET",
                    headers: authManager.getAuthHeaders()
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) {
                    throw new Error(data.error || "Kh√¥ng l·∫•y ƒë∆∞·ª£c l·ªãch s·ª≠");
                }

                const reservations = data.reservations || [];
                if (!reservations.length) {
                    if (emptyEl) emptyEl.style.display = "block";
                    return;
                }

                if (table) table.style.display = "table";

                reservations.forEach(r => {
                    const tr = document.createElement("tr");
                    const createdAt = r.createdAt
                        ? new Date(r.createdAt).toLocaleString("vi-VN")
                        : "-";
                    const expiresAt = r.expiresAt
                        ? new Date(r.expiresAt).toLocaleString("vi-VN")
                        : "-";

                    const statusLabel = r.status || "unknown";

                    tr.innerHTML = `
                        <td>${createdAt}</td>
                        <td>${r.lockerId || "-"}</td>
                        <td>${r.bookingCode || "-"}</td>
                        <td>${statusLabel}</td>
                        <td>${expiresAt}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                alert(err.message || "Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ƒë·∫∑t t·ªß.");
            }
        }

        async function checkReceiverReservation() {
            const statusEl = document.getElementById("pickupStatus");
            const detailEl = document.getElementById("pickupDetail");
            const otpBox = document.getElementById("pickupOtpBox");

            if (statusEl) {
                statusEl.style.display = "none";
                statusEl.textContent = "";
            }
            if (detailEl) detailEl.style.display = "none";
            if (otpBox) otpBox.style.display = "none";
            currentPickupReservationId = null;

            try {
                const res = await fetch(`${API_BASE}/receiver/check-reservation`, {
                    method: "POST",
                    headers: {
                        ...authManager.getAuthHeaders(),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.success === false) {
                    throw new Error(data.error || "Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c ƒë∆°n h√†ng");
                }

                if (!data.hasReservation) {
                    if (statusEl) {
                        statusEl.style.display = "block";
                        statusEl.style.color = "#9ca3af";
                        statusEl.textContent = "Hi·ªán t·∫°i b·∫°n kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang ch·ªù trong t·ªß.";
                    }
                    return;
                }

                const r = data.reservation;
                currentPickupReservationId = r.id;

                if (detailEl) {
                    detailEl.style.display = "block";
                    document.getElementById("pickupLocker").textContent = r.lockerId || "Locker1";
                    document.getElementById("pickupStatusText").textContent = r.status || "-";
                    document.getElementById("pickupExpire").textContent =
                        r.expiresAt ? new Date(r.expiresAt).toLocaleString("vi-VN") : "-";
                }

                if (otpBox) {
                    otpBox.style.display = "block";
                }

                if (statusEl) {
                    statusEl.style.display = "block";
                    statusEl.style.color = "#166534";
                    statusEl.textContent = "ƒê√£ t√¨m th·∫•y ƒë∆°n h√†ng ƒëang ch·ªù. Vui l√≤ng nh·∫≠p OTP ƒë·ªÉ m·ªü t·ªß.";
                }
            } catch (err) {
                console.error(err);
                if (statusEl) {
                    statusEl.style.display = "block";
                    statusEl.style.color = "#b91c1c";
                    statusEl.textContent = err.message || "C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra ƒë∆°n h√†ng.";
                }
            }
        }

        async function verifyPickupOtp() {
            const otpInput = document.getElementById("pickupOtp");
            const otpCode = otpInput ? otpInput.value.trim() : "";

            if (!currentPickupReservationId) {
                alert("B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c ch·ªçn. H√£y b·∫•m 'Ki·ªÉm tra ƒë∆°n h√†ng ƒëang ch·ªù' tr∆∞·ªõc.");
                return;
            }

            if (!otpCode) {
                alert("Vui l√≤ng nh·∫≠p OTP nh·∫≠n h√†ng.");
                return;
            }

            const btn = document.getElementById("btnPickupOpen");
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang m·ªü t·ªß...';
            }

            try {
                const res = await fetch(`${API_BASE}/receiver/verify-and-open`, {
                    method: "POST",
                    headers: {
                        ...authManager.getAuthHeaders(),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        reservationId: currentPickupReservationId,
                        otpCode
                    })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.success === false) {
                    throw new Error(data.error || "Kh√¥ng m·ªü ƒë∆∞·ª£c t·ªß. Vui l√≤ng ki·ªÉm tra l·∫°i OTP.");
                }

                alert("M·ªü t·ªß th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ra t·ªß ƒë·ªÉ l·∫•y h√†ng.");
                // Sau khi l·∫•y h√†ng xong, load l·∫°i l·ªãch s·ª≠
                loadReservations();
            } catch (err) {
                console.error(err);
                alert(err.message || "C√≥ l·ªói x·∫£y ra khi m·ªü t·ªß.");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-door-open"></i> M·ªü t·ªß l·∫•y h√†ng';
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            // M·∫∑c ƒë·ªãnh load l·ªãch s·ª≠ m·ªôt l·∫ßn
            loadReservations();
        });
    </script>
</body>
</html>
